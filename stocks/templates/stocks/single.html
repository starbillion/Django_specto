{% extends 'mainsite/layouts/private/master-frontend-test.html' %}
{% load static %}
{% load generic_filters %}

{% block extraStyles %}
<style type="text/css">
@media (min-width: 993px){
	.m-header--fixed .m-body {
    	padding-top: 100px!important;
	}
}
.stock-logo{
	max-width: 100px;
	height: auto;
}
.ui-datepicker{
	z-index: 9999;
}

/**
 * START: Datepicker
 */
.datepicker-trigger{
	width: 70%;
}
.datepicker-trigger input{
	padding: 5px;
	border: transparent;
	/*display: inline-block	;*/
}
.no-left-margin{
	/*margin-left: 0 !important;*/
}
input.datepicker-trigger{
	/*border: transparent;
	font-size: 1.3em;
    font-weight: 600;*/
}
/**
 * END: Datepicker
 */
</style>
{% endblock %}
{% block content %}
<!-- begin::Body -->
<div class="m-grid__item m-grid__item--fluid m-grid m-grid--ver-desktop m-grid--desktop m-body">
	<!-- BEGIN: Left Aside -->
	<button class="m-aside-left-close  m-aside-left-close--skin-dark " id="m_aside_left_close_btn">
		<i class="la la-close"></i>
	</button>
	
	<!-- END: Left Aside -->
	<div class="m-grid__item m-grid__item--fluid m-wrapper">
		<!-- BEGIN: Subheader -->
		<div class="m-subheader ">
			<div class="d-flex align-items-center">
				<div class="mr-auto">
					<h3 class="m-subheader__title ">{{stock.symbol}}</h3>
					<h4>{{stock.name}}</h4>
					<small>{{stock.symbol}}-{{stock.name}}</small>
				</div>
			</div>
		</div>
		<!-- END: Subheader -->

		<!--begin::Portlet-->
		<div class="m-portlet m-portlet--tabs">
			<div class="m-portlet__head">
				<div class="m-portlet__head-tools">
					<ul class="nav nav-tabs m-tabs-line m-tabs-line--success m-tabs-line--2x" role="tablist">
						<li class="nav-item m-tabs__item">
							<a class="nav-link m-tabs__link active" data-toggle="tab" href="#m_portlet_base_demo_1_tab_content" role="tab">
								Summary
							</a>
						</li>
						<!-- <li class="nav-item m-tabs__item">
							<a class="nav-link m-tabs__link" data-toggle="tab" href="#m_portlet_base_demo_2_tab_content" role="tab">
								Charts
							</a>
						</li> -->
						<li class="nav-item m-tabs__item">
							<a class="nav-link m-tabs__link" data-toggle="tab" href="#m_portlet_base_demo_3_tab_content" role="tab">
								Graph
							</a>
						</li>
						<!-- <li class="nav-item m-tabs__item">
							<a class="nav-link m-tabs__link" data-toggle="tab" href="#m_portlet_base_demo_5_tab_content" role="tab">
								Earnings
							</a>
						</li> -->
						<li class="nav-item m-tabs__item">
							<a class="nav-link m-tabs__link" data-toggle="tab" href="#m_portlet_base_demo_6_tab_content" role="tab">
								Statistics
							</a>
						</li>
						<li class="nav-item m-tabs__item">
							<a class="nav-link m-tabs__link" data-toggle="tab" href="#m_portlet_base_demo_4_tab_content" role="tab">
								Historical Data
							</a>
						</li>

<!-- 						<li class="nav-item m-tabs__item">
							<a class="nav-link m-tabs__link" data-toggle="tab" href="#m_portlet_base_demo_6_tab_content" role="tab">
								Historical Data
							</a>
						</li> -->
					</ul>
				</div>
			</div>
			<div class="clearfix"></div>
			<div class="m-portlet__body">
				<div class="tab-content">
					<div class="tab-pane active" id="m_portlet_base_demo_1_tab_content" role="tabpanel">
						
						<div class="row">
							<div class="col-md-5">
								
								<!--begin:: Widgets/Blog-->
								<div class="m-portlet m-portlet--bordered-semi m-portlet--full-height ">
									<div class="m-portlet__body">
										<div class="m-widget19">
											<!-- <div class="m-widget19__pic m-portlet-fit--sides" style="min-height-: 286px"> -->
												<!-- <img class="stock-logo" src="{{stock_logo}}" alt=""> -->
												<!-- <h3 class="m-widget19__title m--font-light">
													Introducing New Feature
												</h3> -->
											<!-- </div> -->
											<div class="m-widget19__content">
												<div class="m-widget19__header">
													<div class="m-widget19__user-img">
														<img class="m-widget19__img" src="{{stock_logo}}" alt="">
													</div>
													<div class="m-widget19__info">
														<span class="m-widget19__username">
															{{company.companyName}}
														</span>
														<br>
														<span class="m-widget19__time">
															{{company.industry}}
														</span>
													</div>
													<div class="m-widget19__stats">
														<span class="m-widget19__number m--font-brand">
															<a href="{{company.website}}"><i class="fa fa-external-link-square"></i></a>
														</span>
													</div>
												</div>
												<div class="m-widget19__body">
													{{company.description}}
												</div>
											</div>
											<div class="m-widget19__action">
												{% get_stock_fav_status stock.id as fav_status %}

												{% if fav_status %}
													<button href="#" 
													{% if request.user.is_authenticated %}
														data-fav-trigger
													{% endif %} 
													data-fav-status="1" class="btn  btn-info m-btn btn-sm" data-id="{{stock.id}}"
													{% if not request.user.is_authenticated %}
														data-toggle="m-popover" data-content="Login required" data-placement="top"
													{% endif %}
													><i class="la la-heart"></i></button>
												{% else %}
													<button href="#" 
													{% if request.user.is_authenticated %}
														data-fav-trigger 
													{% endif %}
													data-fav-status="0" class="btn  btn-default m-btn btn-sm" data-id="{{stock.id}}"
													{% if not request.user.is_authenticated %}
														data-toggle="m-popover" data-content="Login required" data-placement="top"
													{% endif %}
													><i class="la la-heart"></i></button>
												{% endif %}

												{% get_stock_subscription_status stock.id as subscription_status %}
												{% check_if_stock_in_cart stock.id as stock_in_cart %}

												{% if subscription_status %}
													<!-- <a class="m-btn  btn btn-success btn-sm" data-hide-trigger data-id="{{stock.id}}" href="#" role="button">
														Hide
													</a> -->
												{% else %}
													{% if stock_in_cart %}
														<a class="m-btn  btn btn-danger btn-sm" data-subscribe="0" data-id="{{stock.id}}" href="{% url 'payment.cart' %}" role="button">Go to cart</a>
													{% else %}
														<a class="m-btn  btn btn-danger btn-sm" 
														{% if request.user.is_authenticated %} data-add-to-cart-modal 
														{% endif %} data-already-in-cart="0" data-subscribe="0" data-id="{{stock.id}}" data-symbol="{{stock.symbol}}" href="#" role="button"
														{% if not request.user.is_authenticated %}
														data-toggle="m-popover" data-content="Login required" data-placement="top"
														{% endif %}
														>Subscribe</a>
													{% endif %}
												{% endif %}

											</div>
										</div>
									</div>
								</div>
								<!--end:: Widgets/Blog-->
										
							</div>
							<div class="col-md-7 data-stats-wrap">
								<!--begin::Portlet-->
								<!-- <div class="m-portlet m-portlet--tab"> -->
									<!-- <div class="">
										<div id="chart_summary" style="height: 300px;"></div>
									</div> -->
									

								<!-- </div> -->
								<!--end::Portlet-->
								<div class="row">
									<div class="col-xs-6 col-md-8">
										<div class="m-widget15__item">
											<span class="m-widget15__stats" data-accuracy>
												0%
											</span>
											<span class="m-widget15__text">
												Accuracy
											</span>
											<div class="m--space-10"></div>
											<div class="progress m-progress--sm">
												<div class="progress-bar bg-info" role="progressbar" data-accuracy-style style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
											</div>
										</div>
									</div><!-- END: col-xs-6 -->
									<div class="col-xs-6 col-md-4">
										<!-- <span class="no-left-margin" style="display: inline-block; max-width:200px;">
											<input type='text' class="form-control datepicker-trigger" data-predictions="{{stock.stockprediction_set.select_related.all|to_json}}" id="" placeholder="Select date"/>	
										</span> -->

										<div class='input-group date' id='m_datepicker_2' style="display: inline-flex; max-width:180px;">
											<input type='text' class="form-control m-input datepicker-trigger" readonly  placeholder="Select date"/>
											<span class="input-group-addon">
												<i class="la la-calendar-check-o"></i>
											</span>
										</div>
									</div>
								</div>
								<div class="clearfix"></div>
								<div class="row">
									
									<div class="col-sm-12 col-md-4">
										<div class="m-portlet m-portlet--border-bottom-brand ">
											<div class="m-portlet__body">
												<div class="m-widget26">
													<div class="m-widget26__number">
														<span data-high>N.A.</span>
														<small>
															High
														</small>
													</div>
												</div>
											</div>
										</div>
									</div>
									
									<div class="col-sm-12 col-md-4">
										<div class="m-portlet m-portlet--border-bottom-danger ">
											<div class="m-portlet__body">
												<div class="m-widget26">
													<div class="m-widget26__number">
														<span data-low>N.A.</span>
														<small>
															Low
														</small>
													</div>
												</div>
											</div>
										</div>
									</div>
									
									<div class="col-sm-12 col-md-4">
										<div class="m-portlet m-portlet--border-bottom-success ">
											<div class="m-portlet__body">
												<div class="m-widget26">
													<div class="m-widget26__number">
														<span data-close>N.A.</span>
														<small>
															Close
														</small>
													</div>
												</div>
											</div>
										</div>
									</div>
								
								</div><!-- END: .row -->

							</div>
						
							<div class="col-md-12">
								<div id="chart_summary" style="height: 400px; min-width: 310px"></div>
							</div>

						</div><!-- //END: Row -->
					</div>
					<!-- <div class="tab-pane" id="m_portlet_base_demo_2_tab_content" role="tabpanel">
						It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.
					</div> -->
					<div class="tab-pane" id="m_portlet_base_demo_3_tab_content" role="tabpanel">
						<div class="m-content">
							<!-- <div id="stock-forecast" style="width: 100%; border: solid 5px rgba(0, 0, 0, 0.55); padding: 100px;">
								<h3 class="text-center">Stock Forecast</h3>
							</div> -->
							<div id="container" style="height: 400px; min-width: 310px"></div>
						</div>
					</div>
					<div class="tab-pane" id="m_portlet_base_demo_4_tab_content" role="tabpanel">
						<div class="m-section__content">
							<div class="earnings-data-table m_datatable" data-raw-data dataremove-id="html_table" width="100%"></div>

						</div>
					</div>
					<!-- <div class="tab-pane" id="m_portlet_base_demo_5_tab_content" role="tabpanel">
						<div class="m-portlet__body row">
							
							
						
						</div>
					</div> -->
					<div class="tab-pane" id="m_portlet_base_demo_6_tab_content" role="tabpanel">
						<div class="m-section__content">
							<!-- <div class="row hidden">
								<h3 class="m-section__heading"></h3>
								<div class="col-md-6">
									<div class="m-list-timeline">
										<div class="m-list-timeline__items">
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													Open
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.open }}
												</span>
											</div>
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													Close
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.close }}
												</span>
											</div>
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													High
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.high }}
												</span>
											</div>
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													Low
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.low }}
												</span>
											</div>
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													Latest Volume
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.latestVolume }}
												</span>
											</div>
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													Avg. Volume
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.avgTotalVolume }}
												</span>
											</div>
										</div>
									</div>		
								</div>
								<div class="col-md-6">
									<div class="m-list-timeline">
										<div class="m-list-timeline__items">
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													Market Cap
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.marketCap }}
												</span>
											</div>
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													PE Ratio
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.peRatio }}
												</span>
											</div>
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													Change
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.change }}
												</span>
											</div>
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													Change Percent
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.changePercent }}
												</span>
											</div>
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													Week 52 High
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.week52High }}
												</span>
											</div>
											<div class="m-list-timeline__item">
												<span class="m-list-timeline__badge"></span>
												<span class="m-list-timeline__text">
													Week 52 Low
												</span>
												<span class="m-list-timeline__time">
													{{ stock_realtime.quote.week52Low }}
												</span>
											</div>
										</div>
									</div>		
								</div>
							</div> -->

							<div class="row">
								<div class="col-md-6">
									<h4 class="m-section__heading">Most Active</h4>
									<table class="table">
										<thead>
											<tr>
												<th>Symbol</th>
												<th>Company</th>
												<th>Close</th>
												<th>Change</th>
												<th>Percent Change</th>
											</tr>
										</thead>
										<tbody>
											{% for stats in stats_most_active %}
											<tr>
												<td>{{ stats.symbol }}</td>
												<td>{{ stats.companyName }}</td>
												<td>{{ stats.close }}</td>
												<td>{{ stats.change }}</td>
												<td>{{ stats.changePercent }}</td>
											</tr>
											{% endfor %}
										</tbody>
									</table>		
								</div>
								<div class="col-md-6">
									<h4 class="m-section__heading">Gainers</h4>
									<table class="table">
										<thead>
											<tr>
												<th>Symbol</th>
												<th>Company</th>
												<th>Close</th>
												<th>Change</th>
												<th>Percent Change</th>
											</tr>
										</thead>
										<tbody>
											{% for stats in stats_gainers %}
											<tr>
												<td>{{ stats.symbol }}</td>
												<td>{{ stats.companyName }}</td>
												<td>{{ stats.close }}</td>
												<td>{{ stats.change }}</td>
												<td>{{ stats.changePercent }}</td>
											</tr>
											{% endfor %}
										</tbody>
									</table>		
								</div>
								<div class="col-md-6">
									<h4 class="m-section__heading">Losers</h4>
									<table class="table">
										<thead>
											<tr>
												<th>Symbol</th>
												<th>Company</th>
												<th>Close</th>
												<th>Change</th>
												<th>Percent Change</th>
											</tr>
										</thead>
										<tbody>
											{% for stats in stats_losers %}
											<tr>
												<td>{{ stats.symbol }}</td>
												<td>{{ stats.companyName }}</td>
												<td>{{ stats.close }}</td>
												<td>{{ stats.change }}</td>
												<td>{{ stats.changePercent }}</td>
											</tr>
											{% endfor %}
										</tbody>
									</table>		
								</div>
							</div>

							<div class="row">
								{% for val in earnings.earnings %}
									<div class="m-portlet col-md-6">
										<div class="m-portlet__head">
											<h3 class="m-section__heading">{{val}}</h3>
										</div>
										<div class="m-portlet__body">
											<div class="m-list-timeline">
												<div class="m-list-timeline__items">
													<div class="m-list-timeline__item">
														<span class="m-list-timeline__badge"></span>
														<span class="m-list-timeline__text">
															Actual EPS
														</span>
														<span class="m-list-timeline__time">
															{{val.actualEPS}}
														</span>
													</div>
													<div class="m-list-timeline__item">
														<span class="m-list-timeline__badge"></span>
														<span class="m-list-timeline__text">
															Consensus EPS
														</span>
														<span class="m-list-timeline__time">
															{{val.consensusEPS}}
														</span>
													</div>
													<div class="m-list-timeline__item">
														<span class="m-list-timeline__badge"></span>
														<span class="m-list-timeline__text">
															Announce Time
														</span>
														<span class="m-list-timeline__time">
															{{val.announceTime}}
														</span>
													</div>
													<div class="m-list-timeline__item">
														<span class="m-list-timeline__badge"></span>
														<span class="m-list-timeline__text">
															Number Of Estimates
														</span>
														<span class="m-list-timeline__time">
															{{val.numberOfEstimates}}
														</span>
													</div>
													<div class="m-list-timeline__item">
														<span class="m-list-timeline__badge"></span>
														<span class="m-list-timeline__text">
															EPS Surprise Dollar
														</span>
														<span class="m-list-timeline__time">
															{{val.EPSSurpriseDollar}}
														</span>
													</div>
												</div>
											</div>
										</div>
									</div>
								{% endfor %}
							</div>

						</div>
					</div>
				</div>
			</div>
		</div>
		<!--end::Portlet-->
	</div>
</div>
<!-- end:: Body -->

{% include "stocks/snippets/modal-cart.html" %}

{% endblock %}

{% block extraScripts %}
<script type="text/javascript">
	var CSRF_TOKEN = "{{csrf_token}}";
	var STOCK_SUBSCRIBE_URL = "{% url 'subscription.subscribe_stock' %}";
	var STOCK_FAVOURITE_URL = "{% url 'favourites.favourite_stock' %}";
	var STOCK_ADD_TO_CART_URL = "{% url 'add_to_cart' %}";
	var STOCK_GET_ACTIVE_SUBSCRIPTIONS = "{% url 'subscription.get_active_plans' %}";
	var STOCK_HIDE_SUBSCRIPTION_URL = "{% url 'subscription.hide_stock' %}";
	var STOCK_GOT_TO_CART_URL = "{% url 'payment.cart' %}";
	var URL_STOCK_GET_LIST = "{% url 'stocks.get_list' %}";
	var PAGE_INDEX = 1;
</script>
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
<!-- <script src="{% static 'mainsite/assets/demo/default/custom/components/datatables/base/html-table.js' %}" type="text/javascript"></script> -->

<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script src='{% static "js/single_stock_page.datatable.js" %}' type="text/javascript"></script>

<script type="text/javascript">

	// Set default date format
	// $.datepicker.setDefaults({dateFormat: 'yyyy-mm-dd'});

	function setDate(dateString, splitSymbol="-") {
		// console.log(dateString, splitSymbol)
		if (splitSymbol == '-') {
			var dateArr = dateString.split("-");
			
			var y = parseInt(dateArr[0]);
			var m = parseInt(dateArr[1]);
			m = m-1;
			var d = parseInt(dateArr[2]);

			var date = new Date(y, m, d);
		}
		else{			
			var y = (dateString[0]+dateString[1]+dateString[2]+dateString[3]);
			var m = (dateString[4]+dateString[5]);
			m = m-1;
			var d = (dateString[6]+dateString[7]);
			// var date = new Date(y, m, d);
			return d+"-"+m+"-"+y;
		}
		return date.getTime();
		return Math.floor(date.getTime()/1000);
	}

	var TIME_SERIES_DATA_5Y = {};//{{stock_5y|safe}};
	var TIME_SERIES_DATA_1d    = {};//{{stock_1d|safe}};
	// var TIME_SERIES_DATA_TODAY = {{stock_today|safe}};
	// var TIME_SERIES_DATA_1m    = {{stock_1m|safe}};
	// var TIME_SERIES_DATA_3m    = {{stock_3m|safe}};
	// var TIME_SERIES_DATA_6m    = {{stock_6m|safe}};
	// var TIME_SERIES_DATA_ytd   = {{stock_ytd|safe}};
	// var TIME_SERIES_DATA_1y    = {{stock_1y|safe}};
	// var TIME_SERIES_DATA_2y    = {{stock_2y|safe}};
	// var TIME_SERIES_DATA_5y    = {{stock_5y|safe}}; 

	var d1 = d2 = d3 = [];
	var xLables = [];
	var yLables = [];
	
	var dates = [],
	highs = [],
	lows = [],
	opens = [],
	closes = [],
	setForCandleStick = [];

	var chart_summary_dates = [],
	chart_summary_highs = [],
	chart_summary_lows = [],
	chart_summary_closes = [];

	AjaxCall("{% url 'stock.stats' %}", "get", {'symbol': '{{stock.symbol}}', 'type': 'stock_5y_dict'}, function(e) { updateTimeSeries(e);/*return console.log("Heyaaaa", e)*/}, function() { return console.log("Errorrr", e)});

	jQuery(document).on("click", "[data-add-to-cart-modal]", function(e) {
		e.preventDefault();
		var symbol = $('h3.m-subheader__title').html().trim();
		var id = $(this).data('id');
		AjaxCall(STOCK_GET_ACTIVE_SUBSCRIPTIONS, "post", {'id': id}, successShowCartForm, errorShowCartForm, {'symbol': symbol, 'id': id, '$this': $(this)});
	})

	jQuery("[data-add-to-cart-form] form").on('submit', function(e) {
		e.preventDefault();
		AjaxCall(STOCK_ADD_TO_CART_URL, "post", $(this).serialize(), successProductAddToCart, errorProductAddToCart, {'symbol': $(this).find('input[name="product_symbol"]').val()});
	})

	function successProductAddToCart(data, extraData) {
		if (data.status == '1') {
			$('#subsCartModal').modal('hide');
			toastr.info(data.message)
			// jQuery('.m-widget24__title').each(function(key, val) {
			symbol = jQuery('[data-add-to-cart-modal]').data('symbol');
			// console.log("HEyaa");				
			if (extraData.symbol.toLowerCase() == symbol.toLowerCase()) {
				jQuery('[data-add-to-cart-modal]').html('Go to cart').removeAttr('data-add-to-cart-modal').attr('href', STOCK_GOT_TO_CART_URL).off("click");
				}
			// })
		}
	}

	function errorProductAddToCart(data, extraData) {
		console.log("error", data, extraData);
	}

	// Cart form handlers
	function successShowCartForm(data, extraData) {
		targetModal = "#subsCartModal";
		
		cartForm = jQuery("[data-add-to-cart-form]");
		var plans = $.parseJSON(data.plans);
		var symbol = extraData.symbol;
		var id = extraData.id;

		jQuery(cartForm).find("[data-symbol]").html(symbol);
		priceFirstPlan = 'N.A';
		plansHtml = "";
		if (plans.length > 0) {	
			jQuery(cartForm).find('form').removeClass('hidden');
			jQuery(cartForm).find('[data-invalid-plans]').addClass('hidden');

			for (var i=0; i<plans.length; i++) {
				plansHtml += "<label class='m-radio m-radio--solid'>";
				plansHtml += "<input type='radio' name='plan_duration' value='"+ plans[i].fields.plan_duration +"'";
				if (i == 0)
					plansHtml += " checked='checked' ";
				plansHtml += ">";
				plansHtml += plans[i].fields.plan_duration + " month(s) @ $ " + plans[i].fields.price;
				plansHtml += "<span></span>";
				plansHtml += "</label>";
				// plansHtml += "<option name='"+plans[i].fields.plan_duration+"' data-price='"+plans[i].fields.price+"' value='"+plans[i].fields.plan_duration+"''>"+ plans[i].fields.plan_duration +" month(s)</option>";
			}
			priceFirstPlan = plans[0].fields.price;
		} else {
			jQuery(cartForm).find('[data-invalid-plans]').removeClass('hidden');
			jQuery(cartForm).find('form').addClass('hidden');
		}
		jQuery(cartForm).find('span[data-plan-price]').html(priceFirstPlan);
		jQuery(cartForm).find('input[name="product_id"]').val(id);
		jQuery(cartForm).find("[data-plans]").html(plansHtml);
		jQuery(cartForm).find("input[name='product_symbol']").val(symbol);
		jQuery(targetModal).modal({
			backdrop: false
		});
	}

	function errorShowCartForm(data, extraData) {
		console.log("Success", data, extraData);
	}

	function updateTimeSeries(data) {
		console.log("Call received from ahax result", data);
		earnings_tbl_html = '';
		TIME_SERIES_DATA_5Y = data.data.stock_5y_dict;
		chart_summary_dates.length = chart_summary_highs.length = chart_summary_lows.length = chart_summary_closes.length = d1.length = d2.length = xLables.length = yLables.length = highs.length = lows.length = opens.length = closes.length = setForCandleStick.length = 0; 
		
		for (var i = 0; i < TIME_SERIES_DATA_5Y.length; i++) {
			chart_summary_dates.push(setDate(TIME_SERIES_DATA_5Y[i].date));
			chart_summary_highs.push([setDate(TIME_SERIES_DATA_5Y[i].date), TIME_SERIES_DATA_5Y[i].high]);
			chart_summary_lows.push([setDate(TIME_SERIES_DATA_5Y[i].date), TIME_SERIES_DATA_5Y[i].low]);
			chart_summary_closes.push([setDate(TIME_SERIES_DATA_5Y[i].date), TIME_SERIES_DATA_5Y[i].close]);			

			d1.push([i, TIME_SERIES_DATA_5Y[i].high]);
			// d2.push([i, TIME_SERIES_DATA_5Y[i].high]);
			d2.push([i, TIME_SERIES_DATA_5Y[i].low]);
			xLables.push([i, TIME_SERIES_DATA_5Y[i].label]);
			yLables.push([i, TIME_SERIES_DATA_5Y[i].low]);
			
			dates.push(setDate(TIME_SERIES_DATA_5Y[i].date));
			highs.push([setDate(TIME_SERIES_DATA_5Y[i].date), TIME_SERIES_DATA_5Y[i].high]);
			lows.push([setDate(TIME_SERIES_DATA_5Y[i].date), TIME_SERIES_DATA_5Y[i].low]);
			opens.push([setDate(TIME_SERIES_DATA_5Y[i].date), TIME_SERIES_DATA_5Y[i].open]);
			closes.push([setDate(TIME_SERIES_DATA_5Y[i].date), TIME_SERIES_DATA_5Y[i].close]);
			setForCandleStick.push([setDate(TIME_SERIES_DATA_5Y[i].date), TIME_SERIES_DATA_5Y[i].open, TIME_SERIES_DATA_5Y[i].high, TIME_SERIES_DATA_5Y[i].low, TIME_SERIES_DATA_5Y[i].close]);

			/*earnings_tbl_html += '<tr>';
			earnings_tbl_html += '<td scope="row">'+ TIME_SERIES_DATA_5Y[i].date +'</td>';
			earnings_tbl_html += '<td>'+ TIME_SERIES_DATA_5Y[i].open +'</td>';
			earnings_tbl_html += '<td>'+ TIME_SERIES_DATA_5Y[i].high +'</td>';
			earnings_tbl_html += '<td>'+ TIME_SERIES_DATA_5Y[i].close +'</td>';
			earnings_tbl_html += '<td>'+ TIME_SERIES_DATA_5Y[i].volume +'</td>';
			earnings_tbl_html += '<td>'+ TIME_SERIES_DATA_5Y[i].change +'</td>';
			earnings_tbl_html += '<td>'+ TIME_SERIES_DATA_5Y[i].changePercent +'</td>';
			earnings_tbl_html += '</tr>';*/
		}

		var chart = Highcharts.stockChart('container', {

	        credits: {
	        	enabled: false,
	        },
	        
		    title: {
	            text: '{{stock.symbol}} Stock Price'
	        },
	        yAxis: [{
	        	opposite: false,
	        }],
	        dateFormat: 'Y-m-d',
	        exporting: {
	            buttons: {
	                contextButton: {
	                    enabled: true,
	                },
	                toggle: {
	                    text: '<i class="fa fa-area-cahrt"></i> Chart Type',
	                    menuItems: [{
	                        text: 'Line',
	                        onclick: function () {
	                            var lineIndex = [];
	                            for (var i=0; i<this.series.length; i++){
	                            	if (this.series[i].userOptions.type != 'line') {
	                            		this.series[i].hide();
	                            		continue;
	                            	}
	                            	lineIndex.push(i);
	                            }
	                            for (var i=0; i<lineIndex.length; i++)
	                            	this.series[lineIndex[i]].show();
	                        }
	                    },{
	                        text: 'Area',
	                        onclick: function () {
	                            var lineIndex = [];
	                            for (var i=0; i<this.series.length; i++){
	                            	if (this.series[i].userOptions.type != 'area') {
	                            		this.series[i].hide();//visible = false;
	                            		continue;
	                            	}
	                            	lineIndex.push(i);
	                            }
	                            for (var i=0; i<lineIndex.length; i++)
	                            	this.series[lineIndex[i]].show();
	                        }
	                    },{
	                        text: 'CandleStick',
	                        onclick: function () {
	                        	var lineIndex = [];
	                        	for (var i=0; i<this.series.length; i++){
	                            	if (this.series[i].userOptions.type != 'candlestick') {
	                            		this.series[i].hide();//visible = false;
	                            		continue;
	                            	}
	                            	lineIndex.push(i);
	                            }
	                            for (var i=0; i<lineIndex.length; i++)
                            		this.series[lineIndex[i]].show();
	                        }
	                    }]
	                }
	            }
		    },
	        series: [
		        {
				    name: '{{stock.symbol}}',
		            type: 'candlestick',
		            data: setForCandleStick,
		            visible: false,
		    
		            tooltip: {
		                valueDecimals: 2,
		            	formatter: function() {
				            var s = [];
				            $.each(this.points, function(i, point) {
				                s.push('<span style="color:#D31B22;font-weight:bold;">'+
				                    point.y +'<span>');
				            });

				            return s.join(' and ');
				        },
				        shared: true
		            },
		        },
		        {
				    name: '{{stock.symbol}}',
		            type: 'area',
		            data: setForCandleStick,
		            visible: false,
		            
		            
		            tooltip: {
		                valueDecimals: 2,
		            	formatter: function() {
				            var s = [];
				            $.each(this.points, function(i, point) {
				                s.push('<span style="color:#D31B22;font-weight:bold;">'+
				                    point.y +'<span>');
				            });

				            return s.join(' and ');
				        },
				        shared: true
		            },
		            
		        },
		        {
				    name: 'High',
		            type: 'line',
		            data: highs,
		            visible: true,

		            tooltip: {
		                valueDecimals: 2,
		            	formatter: function() {
				            var s = [];
				            $.each(this.points, function(i, point) {
				                s.push('<span style="color:#D31B22;font-weight:bold;">'+
				                    point.y +'<span>');
				            });

				            return s.join(' and ');
				        },
				        shared: true
		            },
		            
		        },
		        {
				    name: 'Low',
		            type: 'line',
		            data: lows,
		            visible: true,

		            
		            tooltip: {
		                valueDecimals: 2,
		            	formatter: function() {
				            var s = [];
				            $.each(this.points, function(i, point) {
				                s.push('<span style="color:#D31B22;font-weight:bold;">'+
				                    point.y +'<span>');
				            });

				            return s.join(' and ');
				        },
				        shared: true
		            },
		            
		        },
		        {
				    name: 'Open',
		            type: 'line',
		            data: opens,
		            visible: true,

		            
		            tooltip: {
		                valueDecimals: 2,
		            	formatter: function() {
				            var s = [];
				            $.each(this.points, function(i, point) {
				                s.push('<span style="color:#D31B22;font-weight:bold;">'+
				                    point.y +'<span>');
				            });

				            return s.join(' and ');
				        },
				        shared: true
		            }
		        },
		        {
				    name: 'Close',
		            type: 'line',
		            data: closes,
		            visible: true,

		            
		            tooltip: {
		                valueDecimals: 2,
		            	formatter: function() {
				            var s = [];
				            $.each(this.points, function(i, point) {
				                s.push('<span style="color:#D31B22;font-weight:bold;">'+
				                    point.y +'<span>');
				            });

				            return s.join(' and ');
				        },
				        shared: true
		            }
		        },
		    ],
	        
	    }, function(chart) {
			// apply the date pickers
            setTimeout(function() {
		    
		    	$('input.highcharts-range-selector', $(chart.container).parent())
		    		.datepicker({
				        format: "dd/mm/yyyy",    
				        todayBtn: "linked",
				        autoclose: true,
				        todayHighlight: true,
				    });         
			});
        }, 0);
		
		var summaryChart = Highcharts.stockChart('chart_summary', {

	        credits: {
	        	enabled: false,
	        },
        
		    title: {
	            text: ''
	        },
	        // dateFormat: 'Ymd',
	        yAxis: [{
	        	opposite: false,
	        }],
	        dateFormat: 'Y-m-d',

	        series: [
		        {
				    name: 'Actual',
		            type: 'line',
		            data: chart_summary_closes,
		            visible: true,
		        
		        },			        
		        {
				    name: 'Prediction',
		            type: 'line',
		            data: chart_summary_highs,
		            visible: true,
		            // inverted: true,			            
		        },
		      // {
				    // name: 'Average',
		      //       type: 'line',
		      //       data: chart_summary_closes,
		      //       visible: true,
		      //       // inverted: true,			            
		      //   },
		    ],
		    
			exporting: {
				enabled: false,
			},
        
    	}, function(chart) {
			// apply the date pickers
	        setTimeout(function() {
		    
		    	$('input.highcharts-range-selector', $(chart.container).parent())
		    		.datepicker({
				        format: "dd/mm/yyyy",    
				        todayBtn: "linked",
				        autoclose: true,
				        todayHighlight: true,
				    });         
			});
	    }, 0);
	    
		// console.log("Earnings table", earnings_tbl_html);
		// $('.earnings-tbl tbody').html(earnings_tbl_html);

		// Calling the Datatable to populate earnings table
		$('.earnings-data-table').attr('data-raw-data', JSON.stringify(TIME_SERIES_DATA_5Y));
		loadJsonForDataTable();
	}

</script>
<!-- // Plotly.js -->

<!--begin::Page Vendors -->
<script src="{% static 'mainsite/assets/vendors/custom/flot/flot.bundle.js' %}" type="text/javascript"></script>
<!--end::Page Vendors -->  
<!--begin::Page Resources -->

<script type="text/javascript">

	    // $.getJSON('https://www.highcharts.com/samples/data/aapl-c.json', function (data) {
	    // Create the chart
		

		$('input.datepicker-trigger').datepicker({
			format: "dd-mm-yyyy",
			autoclose: true,
			todayHighlight: true,
		})
		.on('changeDate', function(e) {
			var month = parseInt(e.date.getMonth())+1;
			var date = e.date.getDate()+'-'+month.toString()+'-'+e.date.getFullYear();
			// console.log("d changed", e)
			var $thisPrediction = jQuery(e.currentTarget);

			var newHigh = newLow = newClose = 'N.A.';
			var accuracyPercents = '0%'
			jQuery.each($thisPrediction.data('predictions'), function(key, val) {
				// console.log("comparing", val.prediction_date, 'with', date)
				if (val.prediction_date == date) {
					// If matched date
					console.log('Changing', date)
					newHigh = val.high;
					newLow = val.low;
					newClose = val.close;
					accuracyPercents = val.accuracy_prev_day;
				}
			})
			jQuery($thisPrediction).parents('.data-stats-wrap').find('[data-accuracy]').eq(0).html(accuracyPercents);
			jQuery($thisPrediction).parents('.data-stats-wrap').find('[data-accuracy-style]').eq(0).css('width', accuracyPercents);

			jQuery($thisPrediction).parents('.data-stats-wrap').find('[data-low]').eq(0).html(newLow);
			jQuery($thisPrediction).parents('.data-stats-wrap').find('[data-high]').eq(0).html(newHigh);
			jQuery($thisPrediction).parents('.data-stats-wrap').find('[data-close]').eq(0).html(newClose);

		});

		// Set today as current date
		var date = new Date();
		var today = new Date(date.getFullYear(), date.getMonth(), date.getDate());
		var end = new Date(date.getFullYear(), date.getMonth(), date.getDate());
		jQuery('.datepicker-trigger').datepicker('setDate', today);
</script>

<script type="text/javascript">
	// Subscribing to stock
	// Subscribe
	jQuery('[data-subscription-trigger]').on('click', function(e) {
		e.preventDefault();
		var $this = $(this);
		$this.addClass('loading');
		// console.log("Clicked", e, $(this));
		var stock_id = $(this).data('id');
		var subscribe_status = $(this).attr('data-subscribe');
		jQuery.ajax({
			type: 'POST',
			url: STOCK_SUBSCRIBE_URL,
			data: {
				stock_id: stock_id,
				subscribe_status: subscribe_status
			},
			cache: false,
			headers: {
				'X-CSRFToken': '{{csrf_token}}'
			},
			success: function(e) {
				// console.log("success", e)
				// Initially subscribed, turn on subscribe btn
				// console.log('status retutned', e.status);
				$this.removeAttr('data-subscribe')
				if (e.status){
					$this.attr('data-subscribe', '1');
					$this.html('Subscribed');			
					$this.addClass('btn-success');
					$this.removeClass('btn-danger loading');
				}
				else
				{
					$this.attr('data-subscribe', '0');
					$this.html('Subscribe');
					$this.removeClass('btn-success loading');
					$this.addClass('btn-danger');
				}

			},
			error: function(e) {
				console.log("Error", e);
			}

		});
	})

	// Subscribe
	jQuery('button[data-fav-trigger]').on('click', function(e) {
		e.preventDefault();
		var $this = $(this);
		console.log("Clicked", e, $(this));
		var stock_id = $(this).data('id');
		var favourite_status = $(this).attr('data-fav-status');
		jQuery.ajax({
			type: 'POST',
			url: STOCK_FAVOURITE_URL,
			data: {
				stock_id: stock_id,
				favourite_status: favourite_status
			},
			cache: false,
			headers: {
				'X-CSRFToken': '{{csrf_token}}'
			},
			success: function(e) {
				console.log("success", e)
				// Initially subscribed, turn on subscribe btn
				console.log('status retutned', e.status);
				$this.removeAttr('data-subscribe')
				if (e.status){
					$this.attr('data-fav-status', '1');
					$this.addClass('btn-info');
					$this.removeClass('btn-default');
				}
				else
				{
					$this.attr('data-fav-status', '0');
					$this.removeClass('btn-info');
					$this.addClass('btn-default');
				}

			},
			error: function(e) {
				console.log("Error", e);
			}

		});
	})
</script>

<!--end::Page Resources -->
{% endblock %}