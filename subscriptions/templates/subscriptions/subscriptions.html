{% extends 'mainsite/layouts/private/master-frontend-test.html' %}
{% load static %}
{% load generic_filters %}

{% block extraStyles %}
    <link href="{% static 'mainsite/assets/vendors/custom/datatables/datatables.bundle.css' %}" rel="stylesheet"
          type="text/css"/>
    <style type="text/css">
        @media (min-width: 993px) {
            .m-header--fixed .m-body {
                padding-top: 100px !important;
            }
        }

        #m_table_1_filter {
            display: inline;
            float: right;
        }

        tr.row-active {
            border-bottom: solid 5px rgba(30, 200, 30, 0.27) !important;
        }

        tr.row-inactive {
            border-bottom: solid 5px rgba(200, 30, 30, 0.27) !important;
        }

        #m_table_1 {
            table-layout: fixed;
            text-overflow: ellipsis;
        }

        .action {
            min-width: 50px;
        }

        .hide_element {
            display: none;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- begin::Body -->
    <div class="m-grid__item m-grid__item--fluid m-grid m-grid--ver-desktop m-grid--desktop m-body">
        <div class="m-grid__item m-grid__item--fluid m-wrapper">

            <!-- START: M-SUBHEADER -->
            <div class="m-content">
                <div class="m-portlet m-portlet--mobile">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text">
                                    Subscriptions
                                </h3>
                            </div>
                        </div>

                    </div>
                    <div class="m-portlet__body">
                        <!--begin: Search Form -->
                        <!--<div class="m-form m-form&#45;&#45;label-align-right m&#45;&#45;margin-top-20 m&#45;&#45;margin-bottom-30">
                            <div class="row align-items-center">
                                <div class="col-xl-8 order-2 order-xl-1">
                                    <div class="form-group m-form__group row align-items-center">
                                        <div class="col-md-4">
                                            <div class="m-input-icon m-input-icon&#45;&#45;left">
                                                <input type="text" class="form-control m-input m-input&#45;&#45;solid" placeholder="Search..." id="generalSearch">
                                                <span class="m-input-icon__icon m-input-icon__icon&#45;&#45;left">
                                                    <span>
                                                        <i class="la la-search"></i>
                                                    </span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>-->
                        <!--end: Search Form -->

                        <!--begin: Selected Rows Group Action Form -->
                        <!--<div class="m-form m-form&#45;&#45;label-align-right m&#45;&#45;margin-top-20 m&#45;&#45;margin-bottom-30" id="m_datatable_group_action_form">
                            <div class="row align-items-center">
                                <div class="col-xl-12">
                                    <div class="m-form__group m-form__group&#45;&#45;inline">
                                        &lt;!&ndash; <div class="m-form__label m-form__label-no-wrap">
                                            <label class="m&#45;&#45;font-bold m&#45;&#45;font-danger-">
                                                Selected
                                                <span id="m_datatable_selected_number"></span>
                                                records:
                                            </label>
                                        </div> &ndash;&gt;
                                        <div class="m-form__control">
                                            <div class="btn-toolbar">
                                                <div class="dropdown">
                                                    <button type="button" class="btn btn-accent btn-sm dropdown-toggle" data-toggle="dropdown">
                                                        Action
                                                    </button>
                                                    <div class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                                                        <a class="dropdown-item" href="#" data-action-unfavourite-selected>
                                                            Un-favourite
                                                        </a>
                                                        <a class="dropdown-item" href="#" data-action-subscribe-selected>
                                                            Subscribe
                                                        </a>
                                                    </div>
                                                </div>
                                                &lt;!&ndash; &nbsp;&nbsp;&nbsp; &ndash;&gt;
                                                &lt;!&ndash; <button class="btn btn-sm btn-danger" type="button" data-action-unfavourite-all>
                                                    Un-favourite all
                                                </button>
                                                &nbsp;&nbsp;&nbsp;
                                                <button class="btn btn-sm btn-danger" type="button" data-action-remove-all>
                                                    Remove all
                                                </button>
                                                &nbsp;&nbsp;&nbsp;
                                                <button class="btn btn-sm btn-success" type="button" data-action-favourite-all>
                                                    Favourite all
                                                </button>
                                                &ndash;&gt;
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        --><!--end: Selected Rows Group Action Form -->

                        <!--begin: Datatable -->
                        <div class="col-xl-12" style="padding-top: 30px;">
                            {% if table_data %}
                                <table class="table table-striped table-bordered table-hover" id="m_table_1"
                                       style="width:100%">
                                    <thead>
                                    <tr>
                                        <th>---</th>
                                        {% for header in headers|slice:":-1" %}
                                            <th>{{ header | title }}</th>
                                        {% endfor %}
                                        <th>Action</th>
                                    </tr>
                                    </thead>

                                    <tbody id="tdDetails">
                                    {% for mitem in table_data %}
                                        <tr class="rowsClass">
                                            <td class="a">{{ forloop.counter }}</td>
                                            {% get_item mitem 'stock_symbol' as m_data1 %}
                                            <td class="stock_symbol">{{ m_data1 }}</td>
                                            {% for header_attr in header_attributes|slice:"1:-1" %}
                                                {% get_item mitem header_attr as m_data %}
                                                <td class="reorder {{ header_attr }}">{{ m_data }}</td>
                                            {% endfor %}
                                            {% get_item mitem 'action' as m_data2 %}
                                            <td class="action" style="padding-left:0px;padding-right:0px;">{{ m_data2 }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                                <!--end: Datatable -->
                            {% else %}

                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- END: M_CONTENT -->

        </div>
    </div>
    {% include "subscriptions/snippets/modal-multiple-subscribe.html" %}
    {% include "stocks/snippets/modal-cart.html" %}
{% endblock %}

<!-- <div class="m_datatable" id="stocks-data" data-raw-data=""></div> -->

{% block extraScripts %}
    <!--begin::Page Resources -->

    <script src="{% static 'mainsite/assets/vendors/custom/datatables/datatables.bundle.js' %}"
            type="text/javascript"></script>

    <script type="text/javascript">
        var URL_STOCK_SINGLE = '{% url "stock.all" %}';
        var URL_FAVOURITE_REMOVE_ALL = '{% url "fav.remove_all" %}';
        var URL_UNFAVOURITE_ALL = '{% url "fav.unfavourite_all" %}';
        var URL_FAVOURITE_ALL = '{% url "fav.favourite_all" %}';
        var URL_UNFAVOURITE_SELECTED = '{% url "fav.unfavourite_selected" %}';
        var URL_FAVOURITE_REMOVE_SELECTED = '{% url "fav.remove_selected" %}';

        var favourites = [];

        var test;

        function getSelected(id) {
            var ids = [];
            ids.push(id);
            return ids;
        }

        /// STOCK ACTIONS
        // Remove all
        jQuery("[data-action-remove-all]").on("click", function (e) {
            e.preventDefault();
            window.location.href = URL_FAVOURITE_REMOVE_ALL;
        });
        // Unsubscribe all
        jQuery("[data-action-unfavourite-all]").on("click", function (e) {
            e.preventDefault();
            if (confirm("Are you sure you want to remove the selcted stock from favourites list?")) {
                window.location.href = URL_UNFAVOURITE_ALL;
            }
        });
        // Subscribe all
        jQuery("[data-action-favourite-all]").on("click", function (e) {
            e.preventDefault();
            window.location.href = URL_FAVOURITE_ALL;
        });

        function showPopUp(type, title, text) {
            initConfirmModal(type, title, text);
        }

        function initConfirmModal(type, title='Notice', text='Are you sure you want to proceed?') {
            jQuery('[data-confirm-modal] .modal-title').html(title);
            if (type == 'info') {
                jQuery('[data-confirm-modal] [data-action-yes]').hide();
                jQuery('[data-confirm-modal] [data-action-no]').hide();
                jQuery('[data-confirm-modal] [data-action-close]').show();
            } else {
                jQuery('[data-confirm-modal] [data-action-yes]').show();
                jQuery('[data-confirm-modal] [data-action-no]').show();
                jQuery('[data-confirm-modal] [data-action-close]').hide();
            }
            jQuery('[data-confirm-modal] [data-text]').html(text);
            jQuery('[data-confirm-modal]').modal({
                backdrop: false
            });
        }

        function showModal(identifier) {
            jQuery(identifier).modal({
                backdrop: false
            });
            console.log("DOne with showModal");
        }

        function unFavourite(symbol_set, name) {
            //e.preventDefault();
            jQuery('[data-confirm-modal] [data-action-yes]').attr('href', '#');
            var symbol_set = getSelected(symbol_set);
            if (symbol_set.length == 0) {
                showPopUp('info', 'Notice', 'No items selected!');
                return;
            }
            showPopUp('confirm', 'Confirm', 'Are you sure you want to un-favourite the stock - ' + name + '?');

            symbol_set = symbol_set.toString();
            // console.log(symbol_set.toString());
            // console.log(URL_UNFAVOURITE_SELECTED + "?" + symbol_set);
            url = URL_UNFAVOURITE_SELECTED + "?ids=" + symbol_set;
            jQuery('[data-confirm-modal] [data-action-yes]').attr('href', url);
        }

        function subscribeNow(id) {
            var symbol_set = getSelected(id);
            if (symbol_set.length == 0) {
                showPopUp('info', 'Notice', 'No items selected!');
                return;
            }
            console.log("HEYAAA");
            showModal('#modalMultipleSubscribeForm');
        }

        jQuery("[data-action-subscribe-selected]").on("click", function (e) {
            e.preventDefault();
            var symbol_set = getSelected();
            if (symbol_set.length == 0) {
                showPopUp('info', 'Notice', 'No items selected!');
                return;
            }
            console.log("HEYAAA");
            showModal('#modalMultipleSubscribeForm');
        })

        // Unsubscribe selected
        // Subscribe all
        jQuery("[data-action-unfavourite-selected]").on("click", function (e) {
            e.preventDefault();
            jQuery('[data-confirm-modal] [data-action-yes]').attr('href', '#');
            console.log("Selected");
            var symbol_set = getSelected();
            if (symbol_set.length == 0) {
                showPopUp('info', 'Notice', 'No items selected!');
                return;
            }
            showPopUp('confirm', 'Confirm', 'Are you sure you want to un-favourite the selected stock?');
            symbol_set = symbol_set.toString();
            // console.log(symbol_set.toString());
            // console.log(URL_UNFAVOURITE_SELECTED + "?" + symbol_set);
            url = URL_UNFAVOURITE_SELECTED + "?ids=" + symbol_set;
            jQuery('[data-confirm-modal] [data-action-yes]').attr('href', url);
        })
        // Remove selected
        jQuery("[data-action-remove-selected]").on("click", function (e) {
            e.preventDefault();
            console.log("Remove!!");
            var symbol_set = getSelected();
            // symbol_set = symbol_set.toString();
            window.location.href = URL_FAVOURITE_REMOVE_SELECTED + "?ids=" + symbol_set;
        });

        function getSubscriptionButton(stock_id, symbol) {
            ret = '<a href="#" class="btn m-btn m-btn--hover-brand m-btn--icon m-btn--icon-only m-btn--pill" title="Subscribe" data-add-to-cart-modal="" data-already-in-cart="0" data-subscribe="0" data-id="' + stock_id + '" data-symbol="' + symbol + '"><i class="la la-cart-plus"></i></a>';
            return ret;
        }

        function getGotToCartButton(stock_id) {
            return '<a class="btn m-btn m-btn--hover-brand m-btn--icon m-btn--icon-only m-btn--pill" title="Go To Cart" data-subscribe="0" data-id="' + stock_id + '" href="/payment/cart/" ><i class="la la-cart-plus"></i></a>'

        }

        function getDeleteButton(row) {
            return '<a href="#" onclick="unFavourite(\'' + row[15] + '\', \'' + row[1] + '\')" class="btn m-btn m-btn--hover-brand m-btn--icon m-btn--icon-only m-btn--pill" title="Un-favourite" ><i class="la la-remove"></i></a>';
        }

        function setTableOrder(idList) {
            jQuery.ajax({
                type: 'POST',
                url: "{% url 'subscription.set_table_order' %}",
                data: {
                    id_list: idList,
                },
                cache: false,
                headers: {
                    'X-CSRFToken': '{{csrf_token}}'
                },
                success: function (e) {

                },
                error: function (e) {
                    console.log("Error", e);
                }

            });
        }
    </script>


    <script>
        $(document).ready(function () {
            var table = $("#m_table_1").DataTable({
                dom: 'Bfrtip', "autoWidth": false,
                buttons: [
                    {
                        extend: 'colvis',
                        columns: ':not(.hide_element)'
                    }
                ],
                rowReorder: {
                    selector: 'tr td.reorder'
                },
                "fnDrawCallback": function () {
                    $("#m_table_1").removeClass('hide_element');
                },

                columnDefs: [
                    {targets: 0, visible: false, className: "hide_element"},
                    {targets: -2, visible: false, className: "hide_element"},
                    {targets: -3, visible: false, className: "hide_element"},
                    {"width": "50px", "targets": -4},
                    {"width": "50px", "targets": -5},
                    {"width": "50px", "targets": -6},
                    {
                        "render": function (data, type, row) {
                            return getSubscriptionButton(row[16], row[1]);
                            //console.log(data);
                            //return data;

                        },
                        "targets": -1
                    },
                    {
                        "render": function (data, type, row) {

                            if (data < 0) {
                                return '<font color="#FF0000">' + data + ' </font>';
                            }

                            else {
                                return '<font color="#009900">' + data + ' </font>';
                            }
                        },
                        "targets": 4
                    },
                    {
                        "render": function (data, type, row) {

                            if (data < 0) {
                                return '<font color="#FF0000">' + data + ' </font>';
                            }

                            else {
                                return '<font color="#009900">' + data + ' </font>';
                            }
                        },
                        "targets": 5
                    },
                    {
                        "render": function (data, type, row) {
                            return '<a href="' + URL_STOCK_SINGLE + data + '">' + data + '</a>';
                        },
                        "targets": 1
                    }
                ]
            });
            table.on('row-reorder', function (e, diff, edit) {
                setTableOrder(table.columns(16).data().toArray());
            });
            table.on('order.dt', function () {
                setTableOrder(table.columns(16).data().toArray());
            });

        });
    </script>
    <script type="text/javascript">
        var CSRF_TOKEN = "{{csrf_token}}";
        var STOCK_SUBSCRIBE_URL = "{% url 'subscription.subscribe_stock' %}";
        var STOCK_FAVOURITE_URL = "{% url 'favourites.favourite_stock' %}";
        var STOCK_ADD_TO_CART_URL = "{% url 'add_to_cart' %}";
        var STOCK_GET_ACTIVE_SUBSCRIPTIONS = "{% url 'subscription.get_active_plans' %}";
        var STOCK_HIDE_SUBSCRIPTION_URL = "{% url 'subscription.hide_stock' %}";
        var STOCK_GOT_TO_CART_URL = "{% url 'payment.cart' %}";
        var URL_STOCK_GET_LIST = "{% url 'stocks.get_list' %}";
        var PAGE_INDEX = 1;
        var PER_PAGE_STOCKS = {{ stocks|length }};

        jQuery('body').on("focus", ".datepicker-trigger", function () {
            // jQuery('.datepicker-trigger').datepicker({
            // autoclose: true
            $(this).datepicker({
                autoclose: true,
                // }).on('change', function(){

            })
                .on("select", function (formattedDate, date, inst) {
                    $(inst.el).trigger('change');
                })
                .on("changeDate", function (e) {
                    console.log("Change date requested");
                    var month = parseInt(e.date.getMonth()) + 1;
                    var date = e.date.getDate() + '-' + month.toString() + '-' + e.date.getFullYear();
                    console.log("d changed", e)
                    var $thisPrediction = jQuery(document).find(e.currentTarget).parents('.m-widget24__item').eq(0);

                    var newHigh = newLow = newClose = 'No Forecast Available';
                    newAccuracyPreviousDay = '';
                    jQuery.each($thisPrediction.data('predictions'), function (key, val) {
                        console.log("comparing", val.prediction_date, 'with', date)

                        if (val.prediction_date == date) {
                            // If matched date
                            console.log('Changing', date)
                            newHigh = val.high;
                            newLow = val.low;
                            newClose = val.close;
                            newAccuracyPreviousDay = val.accuracy_prev_day;
                        }
                    })
                    $thisPrediction.find('[data-low]').eq(0).html(newLow);
                    $thisPrediction.find('[data-high]').eq(0).html(newHigh);
                    $thisPrediction.find('[data-close]').eq(0).html(newClose);
                    $thisPrediction.find('[data-accuracy-prev_day]').eq(0).html(newAccuracyPreviousDay);
                    $(this).datepicker('hide');
                });
        })

        // Set today as current date

        var date = new Date();
        var today = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        var end = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        // jQuery(document).find('.datepicker-trigger').datepicker('setDate', today);
        currMonth = parseInt(date.getMonth()) + 1;
        var currDate = currMonth + "/" + date.getDate() + "/" + date.getFullYear();

        jQuery(document)
            .find('.datepicker-trigger')
            .val(currDate);
        initLoad();

        function initLoad() {
            var date = new Date();
            var today = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            var end = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            // jQuery(document).find('.datepicker-trigger').datepicker('setDate', today);
            month = parseInt(date.getMonth()) + 1;
            var currDate = currMonth + "/" + date.getDate() + "/" + date.getFullYear()

            // var month = parseInt(e.date.getMonth())+1;
            var date = date.getDate() + '-' + month.toString() + '-' + date.getFullYear();
            // console.log("d changed", e)
            jQuery('div.m-widget24__item').each(function (k, v) {
                // var $thisPrediction = jQuery(document).find(e.currentTarget).parents('.m-widget24__item').eq(0);
                var $thisPrediction = $(v);

                var newHigh = newLow = newClose = 'No Forecast Available';
                newAccuracyPreviousDay = '';

                jQuery.each($thisPrediction.data('predictions'), function (key, val) {
                    console.log("comparing", val.prediction_date, 'with', date)

                    if (val.prediction_date == date) {
                        // If matched date
                        console.log('Changing', date)
                        newHigh = val.high;
                        newLow = val.low;
                        newClose = val.close;
                        newAccuracyPreviousDay = val.accuracy_prev_day;
                    }
                })
                $thisPrediction.find('[data-low]').eq(0).html(newLow);
                $thisPrediction.find('[data-high]').eq(0).html(newHigh);
                $thisPrediction.find('[data-close]').eq(0).html(newClose);
                $thisPrediction.find('[data-accuracy-prev_day]').eq(0).html(newAccuracyPreviousDay);
            });
        }

        // Subscribe
        jQuery(document).on("click", "[data-trigger-load-stock]", function (e) {
            e.preventDefault();
            var $this = $(this);
            console.log("Clicked", e, $(this));
            var stock_id = $(this).data('id');
            var subscribe_status = $(this).attr('data-subscribe');
            jQuery.ajax({
                type: 'POST',
                url: STOCK_SUBSCRIBE_URL,
                data: {
                    stock_id: stock_id,
                    subscribe_status: subscribe_status
                },
                cache: false,
                headers: {
                    'X-CSRFToken': '{{csrf_token}}'
                },
                success: function (e) {
                    console.log("success", e)
                    // Initially subscribed, turn on subscribe btn
                    console.log('status retutned', e.status);
                    $this.removeAttr('data-subscribe')
                    if (e.status) {
                        $this.attr('data-subscribe', '1');
                        $this.html('Subscribed');
                        $this.addClass('btn-success');
                        $this.removeClass('btn-danger');
                    }
                    else {
                        $this.attr('data-subscribe', '0');
                        $this.html('Subscribe');
                        $this.removeClass('btn-success');
                        $this.addClass('btn-danger');
                    }

                },
                error: function (e) {
                    console.log("Error", e);
                }

            });
        })

        // Subscribe
        jQuery(document).on('click', 'button[data-fav-trigger]', function (e) {

            e.preventDefault();
            var $this = $(this);
            console.log("Clicked", e, $(this));
            var stock_id = $(this).data('id');
            var favourite_status = $(this).attr('data-fav-status');
            jQuery.ajax({
                type: 'POST',
                url: STOCK_FAVOURITE_URL,
                data: {
                    stock_id: stock_id,
                    favourite_status: favourite_status
                },
                cache: false,
                headers: {
                    'X-CSRFToken': '{{csrf_token}}'
                },
                success: function (e) {
                    console.log("success", e)
                    // Initially subscribed, turn on subscribe btn
                    console.log('status retutned', e.status);
                    $this.removeAttr('data-subscribe')
                    if (e.status) {
                        $this.attr('data-fav-status', '1');
                        $this.addClass('btn-info');
                        $this.removeClass('btn-default');
                    }
                    else {
                        $this.attr('data-fav-status', '0');
                        $this.removeClass('btn-info');
                        $this.addClass('btn-default');
                    }

                },
                error: function (e) {
                    console.log("Error", e);
                }

            });
            e.stopPropagation();
        })

        // Add to cart
        jQuery('[data-add-to-cart]').on('click', function (e) {
            e.preventDefault();
            var $this = $(this);
            var stock_id = $(this).data('id');
            var cart_status = $(this).attr('data-already-in-cart');
            var qty = 1;
            jQuery.ajax({
                type: 'POST',
                url: STOCK_ADD_TO_CART_URL,
                data: {
                    product_id: stock_id,
                    quantity: qty,
                },
                cache: false,
                headers: {
                    'X-CSRFToken': '{{csrf_token}}'
                },
                success: function (e) {
                    console.log("success", e)
                    // Initially subscribed, turn on subscribe btn
                    console.log('status retutned', e.status);
                    // $this.removeAttr('data-subscribe')

                    /*if (e.status){
                     $this.attr('data-subscribe', '1');
                     $this.html('Subscribed');
                     $this.addClass('btn-success');
                     $this.removeClass('btn-danger');
                     }
                     else
                     {
                     $this.attr('data-subscribe', '0');
                     $this.html('Subscribe');
                     $this.removeClass('btn-success');
                     $this.addClass('btn-danger');
                     }*/

                },
                error: function (e) {
                    console.log("Error", e);
                }

            });
            e.stopPropagation();
        })
        jQuery(document).on('click', '[data-hide-trigger]', function (e) {
            e.preventDefault();
            AjaxCall(STOCK_HIDE_SUBSCRIPTION_URL, "post", {'stock_id': $(this).data('id')}, successHideSubscribedStock, errorHideSubscribedStock, {'$this': $(this)});
        })

        function successHideSubscribedStock(data, extraData) {
            console.log("Success hide subscription stock", data, extraData);
            if (data.status == '1') {
                $(extraData.$this).parents('.stock-widget-wrap').hide('slow');
            }
        }

        function errorHideSubscribedStock(data, extraData) {
            console.log("Error hide subscription stock", data);
            if (data.status == '1') {
                $(extraData.$this).hide('slow');
            }
        }

        jQuery(document).on("click", "[data-add-to-cart-modal]", function (e) {
            e.preventDefault();
            var symbol = $(this).attr('data-symbol');
            var id = $(this).attr('data-id');
            AjaxCall(STOCK_GET_ACTIVE_SUBSCRIPTIONS, "post", {'id': id}, successShowCartForm, errorShowCartForm, {
                'symbol': symbol,
                'id': id,
                '$this': $(this)
            });
            e.stopPropagation();
        })

        // Cart form handlers
        function successShowCartForm(data, extraData) {
            targetModal = "#subsCartModal";

            cartForm = jQuery("[data-add-to-cart-form]");
            var plans = $.parseJSON(data.plans);
            var symbol = extraData.symbol;
            var id = extraData.id;

            jQuery(cartForm).find("[data-symbol]").html(symbol);
            priceFirstPlan = 'N.A';
            plansHtml = "<center>";
            if (plans.length > 0) {
                jQuery(cartForm).find('form').removeClass('hidden');
                jQuery(cartForm).find('[data-invalid-plans]').addClass('hidden');

                for (var i = 0; i < plans.length; i++) {
                    plansHtml += "<div style='cursor: pointer; width:110px; display: inline-block; margin-left: 13px; margin-right: 13px; margin-bottom: 20px;" +
                        "-webkit-box-shadow: 0 0px 17px 3px rgba(0, 0, 0, .2); box-shadow: 0 0px 17px 3px rgba(0, 0, 0, .2);' " +
                        "onclick='add_to_cart(" + plans[i].pk + "," + plans[i].fields.plan_duration + ", 1, " + id + ",\"" + symbol + "\"" + ")'>" +
                        "<div class='' style='background-color: #C6C6C6;padding:1rem 1.5rem 1rem 1.5rem;'>" +
                        "<div class='m-widget26__number' style='color: #ffffff'>" +
                        "<span style='font-size: 20px' data-high>" + plans[i].fields.plan_duration + " <font style='font-size:14px'>month</font></span></div></div>" +
                        "<div style='padding:1.5rem 1.5rem 1.5rem 1.5rem; font-size:23px; color:#616161; font-weight: 500;'>$" + plans[i].fields.price + "</div></div>"

                }
                priceFirstPlan = plans[0].fields.price;
            } else {
                jQuery(cartForm).find('[data-invalid-plans]').removeClass('hidden');
                jQuery(cartForm).find('form').addClass('hidden');
            }
            jQuery(cartForm).find('span[data-plan-price]').html(priceFirstPlan);
            jQuery(cartForm).find('input[name="product_id"]').val(id);
            jQuery(cartForm).find("[data-plans]").html(plansHtml + "</center>");
            jQuery(cartForm).find("input[name='product_symbol']").val(symbol);
            jQuery(targetModal).modal({
                backdrop: false
            });
        }

        function add_to_cart(id, plan_duration, quantity, product_id, product_symbol) {
            var data = {
                "id": id,
                "plan_duration": plan_duration,
                "quantity": quantity,
                "product_id": product_id,
                "product_symbol": product_symbol
            }
            AjaxCall(STOCK_ADD_TO_CART_URL, "post", data, successProductAddToCart, errorProductAddToCart, {'symbol': $(this).find('input[name="product_symbol"]').val()});

        }

        function errorShowCartForm(data, extraData) {
            console.log("Success", data, extraData);
        }

        jQuery("select[data-plans]").on('change', function () {
            jQuery('span[data-plan-price]').html(jQuery(this).find(":selected").data('price'));
        })

        jQuery("[data-add-to-cart-form] form").on('submit', function (e) {
            e.preventDefault();
            AjaxCall(STOCK_ADD_TO_CART_URL, "post", $(this).serialize(), successProductAddToCart, errorProductAddToCart, {'symbol': $(this).find('input[name="product_symbol"]').val()});
        })

        function successProductAddToCart(data, extraData) {
            if (data.status == '1') {
                $('#subsCartModal').modal('hide');
                toastr.info(data.message);
                updateCartIcon();
                jQuery('.m-widget24__title').each(function (key, val) {
                    symbol = jQuery.trim(jQuery(val).html());
                    if (extraData.symbol.toLowerCase() == symbol.toLowerCase()) {
                        jQuery(val).parents('.m-widget24__item').find('[data-add-to-cart-modal]').html('Go to cart').removeAttr('data-add-to-cart-modal').attr('href', STOCK_GOT_TO_CART_URL).off("click");
                    }
                })
            }
            else {
                toastr.info(data.message);
            }
        }

        function errorProductAddToCart(data, extraData) {
            console.log("error", data, extraData);
        }

        /**
         * Infinite scroll
         */
        jQuery(document).on('click', '[data-trigger-load-stock]', function (e) {
            PAGE_INDEX++;
            loadMoreData(PAGE_INDEX, URL_STOCK_GET_LIST);
        })

        /*$(window).scroll(function() {
         if ($(window).scrollTop() + $(window).height() >= $(document).height()) {
         // var last_id = $(".post-id:last").attr("id");
         PAGE_INDEX++;
         loadMoreData(PAGE_INDEX, URL_STOCK_GET_LIST);
         console.log(PAGE_INDEX, "=page index");
         }
         });*/

        function showAjaxLoader(show=true) {
            btnCss = 'block';
            loaderCss = 'none';
            if (show) {
                loaderCss = 'inline-block';
                btnCss = 'none';
            }
            jQuery('[data-trigger-loader]').css('display', loaderCss);
            jQuery('[data-trigger-load-stock]').css('display', btnCss);
        }

        function successPageList(data) {
            console.log("Success", data);
            showAjaxLoader(false);
            $('.stock-widget-wrap-parent').append(data.html);
            jQuery(document).find('.stock-widget-wrap-parent .datepicker-trigger').each(function (key, value) {
                if ((key + 1) > ((PAGE_INDEX - 1) * PER_PAGE_STOCKS)) {
                    console.log("Applying", key, value, PAGE_INDEX);
                    $(value).datepicker('setDate', today);
                } else {
                    console.log("Skipping", key, value, PAGE_INDEX);
                }
            });
        }

        function errorPageList(error) {
            console.log("Error", error);
            showAjaxLoader(false);
        }

        function loadMoreData(page, url) {
            showAjaxLoader();
            AjaxCall(url, "post", {'page': page}, successPageList, errorPageList);
        }


        $(document).ready(function () {
            $(".rowsClass").each(function (index, element) {
                var get_chat_data = setInterval(function () {
                    AjaxCall("{% url 'stock.ajax_stock_single' %}", "get", {
                        'symbol': $(element).find('.stock_symbol').text(),
                    }, function (e) {
                        var stats = e.data.stats;
                        var stats_left = e.data.stats_left;
                        $(element).find(".stock_price").html(stats_left.latestPrice.toFixed(2));
                        var tem = (stats_left.changePercent * 100).toFixed(2);
                        $(element).find(".change").html(tem);
                        $(element).find(".changePercent").html(stats_left.changePercent.toFixed(2));
                        if (stats_left.change.toFixed(2) < 0) {
                            $(element).find(".change").css("color", "#FF0000");
                            $(element).find(".changePercent").css("color", "#FF0000");
                        }
                        else {
                            $(element).find(".change").css("color", "#009900");
                            $(element).find(".changePercent").css("color", "#009900");
                        }
                    }, function (e) {
                        return console.log("Errorrr", e)
                    })
                }, 20000);
            });
        });
    </script>
{% endblock %}